---
apiVersion: helm.toolkit.fluxcd.io/v2beta2
kind: HelmRelease
metadata:
  name: home-assistant
  namespace: home-assistant
spec:
  interval: 5m
  chart:
    spec:
      chart: home-assistant
      version: 0.3.4
      sourceRef:
        kind: HelmRepository
        name: home-assistant
        namespace: home-assistant
      interval: 10m0s
  values:
    replicaCount: 1

    controller:
      type: StatefulSet

    env:
    - name: TZ
      value: Europe/Sofia

    resources:
      requests:
        cpu: 0.1
        memory: 128Mi
      limits:
        cpu: 1
        memory: 768Mi

    persistence:
      enabled: true
      existingClaim: home-assistant

    configuration:
      enabled: true
      forceInit: true
      templateConfig: |-
        default_config:

        http:
          use_x_forwarded_for: true
          trusted_proxies:
          - 192.168.1.170/31
          - 192.168.1.172/30
          - 192.168.1.176/30
          - 192.168.1.180/32
          - 192.168.0.170/31
          - 192.168.0.172/30
          - 192.168.0.176/30
          - 192.168.0.180/32
          - 10.0.0.0/8
          - 172.16.0.0/12
          - 192.168.0.0/16
          - 127.0.0.0/8

        frontend:
          themes: !include_dir_merge_named themes

        automation: !include automations.yaml
        script: !include scripts.yaml
        scene: !include scenes.yaml

        # Proximity must be configured manually in the UI;
        # proximity:
        #   home_tesla:
        #     zone: home
        #     devices:
        #       - device_tracker.tesla_location
        #     tolerance: 10
        #     unit_of_measurement: km

        mqtt: !include mqtt_sensors.yaml
    
    additionalVolumes:
    - name: teslamate-mqtt-sensors
      configMap:
        name: config-teslamate-mqtt-sensors

    additionalMounts:
    - name: teslamate-mqtt-sensors
      mountPath: /config/mqtt_sensors.yaml
      subPath: mqtt_sensors.yaml
