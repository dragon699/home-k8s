---
apiVersion: v1
kind: ConfigMap
metadata:
  name: config-grafana-alloy
  namespace: monitoring
data:
  alloy.yaml: |-
    // Configuration
  
    logging {
      level  = "warn"
      format = "logfmt"
    }

    livedebugging {
      enabled = true
    }

    // Data pipelines


    //////////////////////////////////////////////
    // Collect kubernetes logs
    //////////////////////////////////////////////

    // Discover pods
    discovery.kubernetes "home_pods" {
      role            = "pod"
    }

    // [1] Aggregate logs
    discovery.relabel "home_logs" {
      targets         = discovery.kubernetes.home_pods.targets

      rule {
        source_labels = ["__meta_kubernetes_namespace"]
        action        = "replace"
        target_label  = "namespace"
      }

      rule {
        source_labels = ["__meta_kubernetes_pod_name"]
        action        = "replace"
        target_label  = "pod"
      }

      rule {
        source_labels = ["__meta_kubernetes_pod_container_name"]
        action        = "replace"
        target_label  = "container"
      }

      rule {
        source_labels = ["__meta_kubernetes_pod_label_app_kubernetes_io_name"]
        action        = "replace"
        target_label  = "app"
      }

      rule {
        source_labels = ["__meta_kubernetes_namespace", "__meta_kubernetes_pod_container_name"]
        action        = "replace"
        target_label  = "job"
        separator     = "/"
        replacement   = "$1"
      }

      rule {
        source_labels = ["__meta_kubernetes_pod_uid", "__meta_kubernetes_pod_container_name"]
        action        = "replace"
        target_label  = "__path__"
        separator     = "/"
        replacement   = "/var/log/pods/*$1/*.log"
      }

      rule {
        source_labels = ["__meta_kubernetes_pod_container_id"]
        action        = "replace"
        target_label  = "container_runtime"
        regex         = "^(\\S+):\\/\\/.+$"
        replacement   = "$1"
      }
    }

    // Tail logs
    loki.source.kubernetes "home_logs" {
      targets         = discovery.relabel.home_logs.output
      forward_to      = [loki.process.home_logs.receiver]
    }

    // [2] Aggregate logs
    loki.process "home_logs" {
      stage.static_labels {
        values        = {
          "cluster"   = "home-k8s",
          "source"    = "kubernetes-logs",
        }
      }

      stage.label_drop {
        values        = ["service_name"]
      }

      forward_to      = [loki.write.home_logs.receiver]
    }

    // Write logs to Loki
    loki.write "home_logs" {
      endpoint {
        url           = "http://grafana-loki-gateway.monitoring.svc/loki/api/v1/push"
      }
    }

    //////////////////////////////////////////////



    //////////////////////////////////////////////
    // Collect kubernetes traces
    //////////////////////////////////////////////

    // Auto-instrument traces
    beyla.ebpf "home_traces" {
      discovery {
        services {
          kubernetes {
            namespace       = "ingress-nginx|metallb-system|longhorn|cert-manager|shared|monitoring|immich|teslamate|hostfabtech"
            deployment_name = "."
          }
        }
      }

      attributes {
        kubernetes {
          enable            = "true"
          cluster_name      = "home-k8s"
        }
      }

      metrics {
        features = [
          "application",
        ]
      }

      ebpf {
        track_request_headers      = true
        enable_context_propagation = true
        heuristic_sql_detect       = true
      }

      output {
        traces                     = [otelcol.processor.batch.home_traces.input]
      }
    }

    // Batch traces
    otelcol.processor.batch "home_traces" {
      output {
        traces                     = [
          otelcol.exporter.otlphttp.home_traces.input,
          otelcol.connector.servicegraph.home_metrics.input,
          otelcol.connector.spanmetrics.home_metrics.input,
        ]
      }
    }

    // Write traces to Tempo
    otelcol.exporter.otlphttp "home_traces" {
      client {
        endpoint                   = "http://grafana-tempo-distributor.monitoring.svc:4318"

        tls {
          insecure                 = true
          insecure_skip_verify     = true
        }
      }
    }

    // Generate service graph metrics from traces
    otelcol.connector.servicegraph "home_metrics" {
      dimensions = [
        "http.method",
        "http.request.method",
        "http.target",
        "url.path",
      ]

      output {
        metrics                    = [prometheus.remote_write.home_metrics.input]
      }
    }

    // Generate span metrics from traces
    otelcol.connector.spanmetrics "home_metrics" {
      dimension {
        name                       = "http.method"
        default                    = "GET"
      }

      dimension {
        name = "http.request.method"
        default                    = "GET"
      }

      dimension {
        name                       = "http.target"
      }

      dimension {
        name                       = "url.path"
      }

      aggregation_temporality      = "DELTA"

      histogram {
        explicit {
          buckets                  = ["50ms", "100ms", "250ms", "1s", "5s", "10s"]
        }
      }

      metrics_flush_interval = "15s"
      namespace                    = "traces_spanmetrics"

      output {
        metrics                    = [prometheus.remote_write.home_metrics.input]
      }
    }

    // Write span and service graph metrics to VictoriaMetrics
    prometheus.remote_write "home_metrics" {
      endpoint {
        url                        = "http://victoriametrics-vminsert.monitoring.svc:8480/insert/0/prometheus/api/v1/write"
      }
    }

    //////////////////////////////////////////////
