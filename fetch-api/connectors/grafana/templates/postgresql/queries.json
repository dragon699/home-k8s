[
    {
        "endpoint": "car-battery",
        "query": {
            "id": "teslamate-usable-battery-level",
            "query": "WITH aux AS (SELECT COALESCE(derived_efficiency,car_efficiency) AS efficiency,car_id FROM (SELECT ROUND((charge_energy_added/NULLIF(end_rated_range_km-start_rated_range_km,0))::numeric,3)*100 AS derived_efficiency,COUNT(*) AS count,cars.id AS car_id,cars.efficiency*100 AS car_efficiency FROM cars LEFT JOIN charging_processes ON cars.id=charging_processes.car_id AND duration_min>10 AND end_battery_level<=95 AND start_rated_range_km IS NOT NULL AND end_rated_range_km IS NOT NULL AND charge_energy_added>0 WHERE cars.id=1 GROUP BY 1,3,4 ORDER BY 2 DESC LIMIT 1) AS e), CurrentCapacity AS (SELECT AVG(capacity) AS capacity FROM (SELECT c.rated_battery_range_km*aux.efficiency/c.usable_battery_level AS capacity FROM charging_processes cp INNER JOIN charges c ON c.charging_process_id=cp.id INNER JOIN aux ON cp.car_id=aux.car_id WHERE cp.car_id=1 AND cp.end_date IS NOT NULL AND cp.charge_energy_added>=aux.efficiency AND c.usable_battery_level>0 ORDER BY cp.end_date DESC,c.date DESC LIMIT 100) AS x), last_battery AS (SELECT usable_battery_level,date FROM ((SELECT usable_battery_level,date FROM positions WHERE car_id=1 AND usable_battery_level IS NOT NULL ORDER BY date DESC LIMIT 1) UNION ALL (SELECT c.usable_battery_level,c.date FROM charges c JOIN charging_processes p ON p.id=c.charging_process_id WHERE p.car_id=1 AND c.usable_battery_level IS NOT NULL ORDER BY c.date DESC LIMIT 1)) AS y ORDER BY date DESC LIMIT 1), Lifetime AS (SELECT (SUM(start_rated_range_km-end_rated_range_km) * ((SELECT cars.efficiency*10 FROM cars WHERE id=1)) / SUM(distance))::numeric AS wh_per_km FROM drives WHERE car_id=1 AND distance>0 AND (start_rated_range_km-end_rated_range_km)>0.1) SELECT lb.usable_battery_level AS usable_battery_percentage,(lb.usable_battery_level*COALESCE(cc.capacity,1)/100)::numeric AS usable_battery_kwh,ROUND(((lb.usable_battery_level*COALESCE(cc.capacity,1)/100)::numeric * 10 / Lifetime.wh_per_km),1) AS usable_battery_km FROM last_battery lb CROSS JOIN CurrentCapacity cc CROSS JOIN Lifetime;"
        }
    },
    {
        "endpoint": "car-last-charge",
        "query": {
            "id": "teslamate-last-charge-info",
            "query": "WITH data AS (SELECT start_date,end_date,COALESCE(g.name,CONCAT_WS(', ',COALESCE(addresses.name,nullif(CONCAT_WS(' ',addresses.road,addresses.house_number),'')),addresses.city)) AS location,CASE WHEN NULLIF(mode() within group (order by charger_phases),0) IS NULL THEN 'DC' ELSE 'AC' END AS type,cp.charge_energy_added AS energy_added,start_battery_level AS start_percent,end_battery_level AS end_percent FROM charging_processes cp LEFT JOIN charges c ON cp.id=c.charging_process_id LEFT JOIN positions p ON p.id=cp.position_id LEFT JOIN addresses ON addresses.id=cp.address_id LEFT JOIN geofences g ON g.id=geofence_id WHERE cp.car_id=1 AND (cp.charge_energy_added IS NULL OR cp.charge_energy_added>0) GROUP BY cp.id,p.id,g.id,addresses.id ORDER BY start_date DESC) SELECT start_date AS date,location,type,energy_added,start_percent,end_percent FROM data LIMIT 1;"
        }
    },
    {
        "endpoint": "car-last-location",
        "query": {
            "id": "teslamate-last-seen-location",
            "query": "SELECT COALESCE(a.city, a.neighbourhood, '') AS city, COALESCE(g.name, array_to_string(((string_to_array(a.display_name, ', ', ''))[0:2]), ', ')) AS address, l.end_date AS \"time\" FROM (SELECT address_id, geofence_id, start_date AS end_date FROM charging_processes WHERE car_id = 1 AND end_date IS NOT NULL UNION SELECT end_address_id AS address_id, end_geofence_id AS geofence_id, end_date FROM drives WHERE car_id = 1 AND end_date IS NOT NULL) l INNER JOIN addresses a ON l.address_id = a.id LEFT JOIN geofences g ON l.geofence_id = g.id ORDER BY l.end_date DESC LIMIT 1;"
        }
    },
    {
        "endpoint": "car-state",
        "query": {
            "id": "teslamate-car-state",
            "query": "SELECT state, start_date AS since FROM (SELECT start_date,'driving'::text AS state FROM drives WHERE car_id = 1 UNION ALL SELECT start_date,'charging'::text AS state FROM charging_processes WHERE car_id = 1 UNION ALL SELECT start_date,'updating'::text AS state FROM updates WHERE car_id = 1 UNION ALL SELECT start_date,state::text FROM states WHERE car_id = 1) AS all_states ORDER BY start_date DESC LIMIT 1;"
        }
    },
    {
        "endpoint": "car-efficiency",
        "query": {
            "id": "teslamate-car-efficiency",
            "query": "WITH Aux AS (SELECT COALESCE(AVG((c.rated_battery_range_km*(cars.efficiency*100)/c.usable_battery_level))::numeric,1) AS usable_kwh FROM charging_processes cp JOIN charges c ON c.charging_process_id=cp.id JOIN cars ON cars.id=cp.car_id WHERE cp.car_id=1 AND cp.end_date IS NOT NULL AND cp.charge_energy_added>=cars.efficiency*100 AND c.usable_battery_level>0), RatedWh AS (SELECT (cars.efficiency*10)::numeric AS rated_wh_per_km FROM cars WHERE id=1), Lifetime AS (SELECT (SUM(start_rated_range_km-end_rated_range_km)*(SELECT rated_wh_per_km FROM RatedWh)/SUM(distance))::numeric AS wh_per_km FROM drives WHERE car_id=1 AND distance>0 AND (start_rated_range_km-end_rated_range_km)>0.1), Eff AS (SELECT ROUND(((SUM(distance)/SUM(start_rated_range_km-end_rated_range_km))*100)::numeric,1) AS driving_efficiency_pct FROM drives WHERE car_id=1 AND distance>0 AND (start_rated_range_km-end_rated_range_km)>0.1) SELECT Eff.driving_efficiency_pct, ROUND(Lifetime.wh_per_km*100,1) AS wh_per_km, ROUND(Aux.usable_kwh,2) AS usable_kwh, ROUND((Aux.usable_kwh*10)/Lifetime.wh_per_km,1) AS real_world_range_km FROM Lifetime,Aux,Eff;"
        }
    }
]
